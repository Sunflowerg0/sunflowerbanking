<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage User Funds - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Define the custom accent color
                        'bank-blue': {
                            DEFAULT: '#0076a3', // Primary blue
                            dark: '#005f82',    // Darker hover blue
                        },
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        .banking-bg {
            background-image: url('https://i.imgur.com/uKhPaS5.jpeg');
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: rgba(0, 0, 0, 0.5); 
            background-blend-mode: overlay;
        }
        /* Custom style for selected account radio button */
        input[type="radio"]:checked + span {
            /* Tailwind classes for checked state */
            @apply bg-bank-blue text-white shadow-lg;
        }
        input[type="radio"]:not(:checked) + span {
            /* Tailwind classes for unchecked state */
            @apply bg-gray-200 text-gray-700 hover:bg-white;
        }
    </style>
</head>

<body class="banking-bg min-h-screen text-gray-800">

    <header class="h-16 w-full p-4 flex items-center justify-between bg-black/50 backdrop-blur-sm shadow-xl fixed top-0 z-40">
        <h1 class="text-xl sm:text-2xl font-bold text-white tracking-wider">Account Fund Manager</h1>
        <button onclick="goToUserList()" 
            class="bg-gray-600 text-white px-3 py-1 rounded-lg text-sm shadow-lg hover:bg-gray-700 transition duration-150 transform hover:scale-105">
            &larr; Back to Users
        </button>
    </header>

    <div id="toast-container" class="fixed top-20 right-4 space-y-2 z-50"></div>

    <main class="pt-24 pb-8 px-4 sm:px-8">
        <div class="max-w-xl mx-auto bg-white/95 backdrop-blur-sm shadow-2xl rounded-xl p-6 sm:p-8">
            
            <header class="mb-6 border-b pb-4">
                <h2 class="text-2xl font-extrabold text-bank-blue">Manage Funds for: <span id="user-name" class="text-gray-700 font-semibold text-xl">Loading...</span></h2>
                <p class="text-gray-600 mt-1 text-sm" id="user-id-display">User ID: N/A</p>
            </header>

            <div class="bg-bank-blue/10 border-l-4 border-bank-blue p-4 rounded-lg mb-8 shadow-inner hidden" id="balance-card">
                <p class="text-sm font-medium text-bank-blue-dark mb-3">Account Balances</p>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Checking (<span id="checking-num">...</span>)</p> 
                        <p id="checking-balance" class="text-2xl font-extrabold text-bank-blue-dark mt-0.5">--.--</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Savings (<span id="savings-num">...</span>)</p>
                        <p id="savings-balance" class="text-2xl font-extrabold text-bank-blue-dark mt-0.5">--.--</p>
                    </div>
                </div>
            </div>

            <div id="loading-indicator" class="text-center p-12 text-bank-blue font-semibold">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Fetching User Details...</span>
                </div>
            </div>

            <form id="transaction-form" class="space-y-6 hidden" onsubmit="handleTransaction(event)">
                
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Target Account Type</label>
                    <div class="flex space-x-4">
                        <label for="account-checking" class="flex-1 text-center cursor-pointer">
                            <input type="radio" id="account-checking" name="targetAccountType" value="checking" checked onchange="updateAccountDisplay()" class="hidden">
                            <span id="label-checking" class="block px-4 py-2 text-sm font-semibold rounded-lg transition duration-200">
                                Checking
                            </span>
                        </label>
                        <label for="account-savings" class="flex-1 text-center cursor-pointer">
                            <input type="radio" id="account-savings" name="targetAccountType" value="savings" onchange="updateAccountDisplay()" class="hidden">
                            <span id="label-savings" class="block px-4 py-2 text-sm font-semibold rounded-lg transition duration-200">
                                Savings
                            </span>
                        </label>
                    </div>
                    <input type="hidden" id="target-account-number" name="accountNumber" value="" required>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Target Account Number</label>
                    <p id="target-account-display" class="p-2.5 bg-gray-50 border border-gray-300 rounded-md font-mono text-sm text-gray-700">
                        Select an account type above...
                    </p>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="flex space-x-4 bg-gray-100 p-1 rounded-lg">
                        <button type="button" id="type-credit" onclick="setTransactionType('credit')" 
                                class="flex-1 px-4 py-2 text-sm font-semibold rounded-md shadow-sm transition duration-200 bg-bank-blue text-white">
                            Credit (Deposit)
                        </button>
                        <button type="button" id="type-debit" onclick="setTransactionType('debit')" 
                                class="flex-1 px-4 py-2 text-sm font-semibold rounded-md transition duration-200 text-gray-600 hover:bg-white">
                            Debit (Withdrawal)
                        </button>
                    </div>
                    <input type="hidden" id="transaction-type" name="type" value="credit" required>
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Amount to Transfer</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span id="currency-prefix" class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                            $
                        </span>
                        <input type="number" step="0.01" min="0.01" id="amount" name="amount" required
                               class="focus:ring-bank-blue focus:border-bank-blue block w-full rounded-none rounded-r-md sm:text-sm border-gray-300 p-2.5" 
                               placeholder="100.00">
                    </div>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description / Reason for Transfer (Required for Audit)</label>
                    <div class="mt-1">
                        <textarea id="description" name="description" rows="3" required
                                   class="shadow-sm focus:ring-bank-blue focus:border-bank-blue block w-full sm:text-sm border border-gray-300 rounded-md p-2.5" 
                                   placeholder="e.g., 'Initial bonus credit' or 'Reversing unauthorized charge'"></textarea>
                    </div>
                </div>

                <button type="submit" id="submit-btn"
                        class="w-full justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-bank-blue hover:bg-bank-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-bank-blue transition duration-150 transform hover:scale-[1.01] flex items-center">
                    <span id="submit-text">Confirm Credit of $</span>
                </button>
                <p id="transaction-error" class="text-sm text-red-600 text-center hidden"></p>
            </form>
        </div>
    </main>

<script>
    // ----------------------------------------------------------------------
    // --- CONFIGURATION & GLOBALS ---
    // ----------------------------------------------------------------------
   // --- Configuration (Real Endpoints) ---
    // NOTE: These are the assumed REST API endpoints for a Node.js/Express backend.
    const API_USER_DETAIL_URL = '/api/users/'; // Will be appended with userId, e.g., /api/users/user-1001
    const API_FUNDS_TRANSFER_URL = '/api/funds/transfer'; // POST request
    const USER_LIST_PAGE = 'view-user-account.html';
    const LOGIN_PAGE = 'admin-login.html';

    // --- Global State ---
    let userId = null;
    let currentLiveUser = null; // Will hold the active user object loaded from the API

    // --- Utility Functions ---

    /**
     * Formats a number to currency string.
     */
    const formatCurrency = (amount, currency = '$') => {
        // Ensure amount is treated as a number
        const numAmount = parseFloat(amount);
        if (isNaN(numAmount)) return `${currency} 0.00`;
        return `${currency} ${numAmount.toFixed(2)}`;
    };

    /**
     * Clears local storage and redirects to the login page.
     */
    const logoutAndRedirect = () => {
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminName');
        showToast('Session expired or unauthorized. Please log in again.', 'error');
        // Set a slight delay for the toast to show
        setTimeout(() => { window.location.href = LOGIN_PAGE; }, 1500);
    }

    const goToUserList = () => {
        window.location.href = USER_LIST_PAGE; 
    }

    // Custom Toast/Notification Function (Remains the same)
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        let baseClasses = "p-4 rounded-lg shadow-md text-sm font-semibold flex items-center min-w-max transition transform duration-500 ease-out translate-x-full opacity-0";
        let iconSvg = '';

        switch (type) {
            case 'success':
                baseClasses += " bg-green-500 text-white";
                iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2l4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                break;
            case 'error':
                baseClasses += " bg-red-600 text-white";
                iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                break;
            case 'info':
            default:
                baseClasses += " bg-bank-blue text-white";
                iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                break;
        }

        toast.className = baseClasses;
        toast.innerHTML = iconSvg + `<span>${message}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 10); 
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    };
    
    // --- Form UI Logic (Simplified and Re-used) ---

    /**
     * Updates the UI elements based on the fetched user data.
     */
    const updateUI = (user) => {
        currentLiveUser = user;
        const currency = user.currency || '$';
        
        document.getElementById('user-name').textContent = user.fullName || 'User Account';
        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
        document.getElementById('currency-prefix').textContent = currency;

        // Update Account Balances
        // Use optional chaining or defensive checks for safety, though the backend is now fixed
        const checkingAccount = user.accounts.checking || {};
        const savingsAccount = user.accounts.savings || {};
        
        const checkingBalance = checkingAccount.balance || 0.00;
        const savingsBalance = savingsAccount.balance || 0.00;
        const checkingNumber = checkingAccount.number || 'N/A';
        const savingsNumber = savingsAccount.number || 'N/A';

        // Display balances
        document.getElementById('checking-balance').textContent = formatCurrency(checkingBalance, currency);
        document.getElementById('savings-balance').textContent = formatCurrency(savingsBalance, currency);
        
        // Display account numbers
        document.getElementById('checking-num').textContent = checkingNumber;
        document.getElementById('savings-num').textContent = savingsNumber;
        
        // Re-run account display and transaction type update
        updateAccountDisplay();
        setTransactionType(document.getElementById('transaction-type').value);

        document.getElementById('balance-card').classList.remove('hidden');
        document.getElementById('transaction-form').classList.remove('hidden');
        document.getElementById('loading-indicator').classList.add('hidden');
    }

    /**
     * Updates the displayed target account number and visual state.
     */
    window.updateAccountDisplay = () => {
        if (!currentLiveUser) return;

        const type = document.querySelector('input[name="targetAccountType"]:checked').value;
        const account = currentLiveUser.accounts[type];
        
        if (account && account.number) {
            document.getElementById('target-account-display').textContent = account.number;
            document.getElementById('target-account-number').value = account.number;
        } else {
            document.getElementById('target-account-display').textContent = 'Account Not Available';
            document.getElementById('target-account-number').value = '';
        }

        // Apply active class visually using the hidden input's checked state CSS (This handles the radio button visuals)
        document.getElementById('account-checking').checked = type === 'checking';
        document.getElementById('account-savings').checked = type === 'savings';
    }

   /**
     * Sets the transaction type (Credit or Debit) and updates the UI accordingly.
     * @param {string} type - 'credit' or 'debit'
     */
    window.setTransactionType = (type) => {
        const isCredit = type === 'credit';
        // Get all elements and use defensive checks immediately
        const creditBtn = document.getElementById('type-credit');
        const debitBtn = document.getElementById('type-debit');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const hiddenInput = document.getElementById('transaction-type');
        
        // If critical elements are missing, abort the UI update safely.
        if (!submitText || !submitBtn) {
            console.error("Critical UI elements for transaction button not found. Aborting UI update.");
            return; 
        }

        hiddenInput.value = type;
        const currency = currentLiveUser ? currentLiveUser.currency : '$';

        // UI updates for Credit/Debit buttons and submit button color
        // Note: We check if creditBtn/debitBtn exist before manipulating their classes
        if (isCredit) {
            if (creditBtn && debitBtn) {
                creditBtn.classList.add('bg-bank-blue', 'text-white');
                creditBtn.classList.remove('text-gray-600', 'hover:bg-white');
                debitBtn.classList.remove('bg-bank-blue', 'text-white');
                debitBtn.classList.add('text-gray-600', 'hover:bg-white');
            }
            submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-600');
            submitBtn.classList.add('bg-bank-blue', 'hover:bg-bank-blue-dark', 'focus:ring-bank-blue');
            submitText.textContent = `Confirm Credit of ${currency}`;
        } else {
            if (creditBtn && debitBtn) {
                creditBtn.classList.remove('bg-bank-blue', 'text-white');
                creditBtn.classList.add('text-gray-600', 'hover:bg-white');
                debitBtn.classList.add('bg-bank-blue', 'text-white');
                debitBtn.classList.remove('text-gray-600', 'hover:bg-white');
            }
            submitBtn.classList.remove('bg-bank-blue', 'hover:bg-bank-blue-dark', 'focus:ring-bank-blue');
            submitBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-600');
            submitText.textContent = `Confirm Debit of ${currency}`;
        }
    }

    // --- Data Fetching (REAL API CALLS) ---

    /**
     * Fetches user details by ID from the real backend API.
     */
    const fetchUserDetails = async () => {
        const token = localStorage.getItem('adminToken');
        if (!token) { logoutAndRedirect(); return; }
        if (!userId) { 
            document.getElementById('loading-indicator').innerHTML = '<p class="text-red-600 font-bold">Error: Missing User ID in URL.</p><button onclick="goToUserList()" class="mt-4 text-bank-blue hover:underline">Go back to User List</button>';
            showToast('Missing User ID in URL.', 'error'); 
            return; 
        }

        const url = API_USER_DETAIL_URL + userId;
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.classList.remove('hidden');

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.status === 401) {
                logoutAndRedirect();
                return;
            }

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
                throw new Error(errorBody.message || `Failed to fetch user data: Status ${response.status}`);
            }

            const user = await response.json();
            updateUI(user);

        } catch (error) {
            console.error("Fetch User Details Error:", error);
            loadingIndicator.innerHTML = `<p class="text-red-600 font-bold">Error loading user: ${error.message}</p><button onclick="goToUserList()" class="mt-4 text-bank-blue hover:underline">Go back to User List</button>`;
            showToast(`Error: ${error.message}`, 'error');
        }
    };

    // --- Transaction Handling (REAL API CALL) ---

    /**
     * Handles the Credit/Debit transaction form submission by calling the real API.
     */
    const handleTransaction = async (event) => {
        event.preventDefault();
        
        const token = localStorage.getItem('adminToken');
        if (!token) { logoutAndRedirect(); return; }

        const form = event.target;
        const amount = parseFloat(form.amount.value);
        const type = form.type.value;
        const description = form.description.value.trim();
        const targetAccountType = form.targetAccountType.value; // 'checking' or 'savings'
        const targetAccountNumber = form.accountNumber.value;
        
        const submitBtn = document.getElementById('submit-btn');
        const errorDisplay = document.getElementById('transaction-error');

        errorDisplay.classList.add('hidden');

        if (isNaN(amount) || amount <= 0) {
            errorDisplay.textContent = 'Please enter a valid amount greater than zero.';
            errorDisplay.classList.remove('hidden');
            return;
        }

        if (description.length < 5) {
            errorDisplay.textContent = 'Please provide a detailed description (at least 5 characters) for audit purposes.';
            errorDisplay.classList.remove('hidden');
            return;
        }

        // Temporarily disable button and show loading text
        submitBtn.disabled = true;
        const originalButtonContent = submitBtn.innerHTML;
        submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Processing...</span>`;

        const transactionData = {
            userId: userId,
            accountNumber: targetAccountNumber,
            type: type, // 'credit' or 'debit'
            amount: amount,
            description: description,
            adminName: localStorage.getItem('adminName') || 'System Admin'
        };

        try {
            // REAL API POST call to the fund transfer endpoint
            const response = await fetch(API_FUNDS_TRANSFER_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(transactionData)
            });

            if (response.status === 401) {
                logoutAndRedirect();
                return;
            }

            const result = await response.json();

            if (!response.ok) {
                // Handle server-side validation or business logic errors (e.g., insufficient funds)
                throw new Error(result.message || `Server responded with status ${response.status}`);
            }
            
            // Expected successful result structure: { success: true, newBalance: 1234.56, currency: '$' }
            const newBalanceText = formatCurrency(result.newBalance, result.currency || (currentLiveUser ? currentLiveUser.currency : '$'));

            showToast(`Funds ${type === 'credit' ? 'credited to' : 'debited from'} ${currentLiveUser.fullName}'s ${targetAccountType.toUpperCase()} account successfully! New balance: ${newBalanceText}`, 'success');
            
            // Clear form inputs 
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            
            // Re-fetch details to update the balance card UI from the server's source of truth
            await fetchUserDetails(); 

        } catch (error) {
            console.error("Transaction Error:", error);
            errorDisplay.textContent = `Transaction failed: ${error.message}`;
            errorDisplay.classList.remove('hidden');
            showToast(`Transaction Failed! ${error.message}`, 'error');
        } finally {
            submitBtn.disabled = false;
            // Restore button text/icon after processing
            if (currentLiveUser) { 
                setTransactionType(type); 
            } else {
                // Fallback for cases where initial load failed but transaction succeeded (unlikely but safe)
                submitBtn.innerHTML = originalButtonContent;
            }
        }
    };


    // ----------------------------------------------------------------------
    // --- INITIALIZATION ---
    // ----------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('adminToken');

        // 1. Check Auth Token (Real check: will only proceed if a token exists)
        if (!token) {
            logoutAndRedirect(); 
            return;
        }
        
        // 2. Get User ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        // Note: The userId in a real app should be a database ID (e.g., MongoDB ObjectId or a UUID)
        userId = urlParams.get('id'); 

        // 3. Set initial form state
        document.getElementById('account-checking').checked = true;
        // NOTE: setTransactionType is called here, but the fix inside the function
        // prevents the TypeError even if currentLiveUser is null initially.
        setTransactionType('credit'); // Credit is the default
        
        // 4. Fetch user data (Real API Call)
        fetchUserDetails();
    });
    </script>
</body>
</html>