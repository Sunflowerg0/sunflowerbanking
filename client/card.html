<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunflower Bank - Card Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bank-blue': '#0076a3', // Deep Cyan/Teal
                        'bank-yellow': '#ffc42a', // Vibrant Sunflower Yellow
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Ensures the background image and its overlay are consistent with the login page design */
        .banking-bg {
            background-image: url('https://i.imgur.com/uKhPaS5.jpeg');
            background-size: cover; 
            background-position: center;
        }
        .text-bank-blue {
            color: #0076a3;
        }
        /* Style for the custom alert/modal */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid #ffc42a;
            max-width: 90%;
            width: 380px;
            text-align: center;
        }
        .message-box button {
            margin-top: 15px;
            padding: 8px 16px;
            background-color: #0076a3;
            color: white;
            border-radius: 8px;
            transition: background-color 0.15s;
        }
        .message-box button:hover {
            background-color: #005f82;
        }

        /* Sidebar Custom Styles */
        .sidebar {
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .sidebar-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }
        .header-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 160px;
            background-color: #0076a3;
            z-index: 0;
        }
        .main-content-wrapper {
            padding-top: 4rem; /* Match dashboard padding */
        }

        /* Bank Card Specific Styles */
        .bank-card {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1.586 / 1; /* Standard credit card ratio */
            background: linear-gradient(135deg, #0076a3 0%, #00a3d9 100%);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s, filter 0.5s;
        }
        .bank-card.frozen {
            filter: grayscale(80%) brightness(80%);
        }
        
        /* Custom class for centered VISA logo to prevent text obstruction */
        .card-visa-center {
            font-size: 5rem; /* Larger text for motif */
            font-weight: 900; /* Black */
            color: rgba(255, 255, 255, 0.1); /* Very subtle white opacity */
            letter-spacing: 0.1em;
            line-height: 1;
            transform: translateY(-5%); /* Slight vertical adjustment */
        }
        /* Media query for smaller screens */
        @media (max-width: 640px) {
            .card-visa-center {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    
    <div id="message-box-container" class="hidden"></div>
    
    <div id="sidebar-backdrop" class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <nav id="sidebar" class="sidebar bg-white p-4 shadow-xl flex flex-col justify-between">
        <div>
            <div class="flex justify-between items-center pb-6 border-b border-gray-100">
                <div class="flex items-center text-xl font-bold text-bank-blue">
                    <img src="https://placehold.co/30x30/0076a3/ffffff?text=SB" alt="Logo" class="mr-2">
                    Menu
                </div>
                <button id="close-sidebar-button" class="text-gray-500" onclick="toggleSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <ul class="pt-4 space-y-2">
                <li>
                    <a href="../client/user-dashboard.html" class="flex items-center p-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2.586l1.293 1.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center p-3 text-sm font-semibold text-bank-blue bg-bank-yellow/30 rounded-lg transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                        Bank Card
                    </a>
                </li>
                <li>
                    <a href="/client/profile.html" class="flex items-center p-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        Profile
                    </a>
                </li>
                <li>
                    <a href="/client/settings.html" class="flex items-center p-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.827 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.827 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.827-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.827-3.31 2.37-2.37h.003z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        Settings
                    </a>
                </li>
            </ul>
        </div>
        
        <button id="sidebar-logout-button" class="flex items-center p-3 text-sm font-medium text-red-600 rounded-lg hover:bg-red-50 transition duration-150 mt-auto" onclick="handleLogout()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            Log Out
        </button>
    </nav>
    
    <div class="banking-bg header-background"></div>

    <div class="relative z-10 p-4 md:p-8 max-w-7xl mx-auto main-content-wrapper">

        <header class="flex justify-between items-center mb-8 pt-2">
            <div class="flex items-center space-x-4">
                <button id="menu-button" class="text-white cursor-pointer" onclick="toggleSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                <div id="greeting-text" class="text-xl md:text-3xl font-semibold text-white mt-1">
                    Manage Your Card
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <button id="logout-button" class="text-xs text-white/80 hover:text-white font-medium transition duration-150 p-1 rounded-md" onclick="handleLogout()">
                    Log Out
                </button>
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-bank-yellow flex items-center justify-center text-white font-bold text-lg overflow-hidden border-2 border-white shadow-md">
                    <img id="avatar-img" src="https://placehold.co/40x40/ffc42a/0076a3?text=SB" alt="User Avatar" class="w-full h-full object-cover">
                </div>
            </div>
        </header>
        
        <main class="max-w-xl mx-auto space-y-8">
            
            <div class="space-y-6">

                <!-- CARD DISPLAY AREA -->
                <div class="flex justify-center items-start pt-6">
                    <div id="card-display" class="bank-card rounded-xl shadow-2xl text-white p-6 transition duration-500 hover:shadow-bank-blue/50">
                        
                        <!-- Frozen Overlay -->
                        <div id="card-status-overlay" class="absolute inset-0 bg-red-600/80 rounded-xl flex flex-col items-center justify-center text-center p-4 opacity-0 transition-opacity duration-500 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                            <p class="text-2xl font-bold">CARD FROZEN</p>
                            <p class="text-sm mt-1 opacity-90">All transactions are temporarily blocked.</p>
                        </div>
                        
                        <!-- 1. BANK LOGO (New location: Top Right) -->
                        <img src="https://i.imgur.com/Q6dsATF.png" alt="Sunflower Bank Logo" class="absolute top-4 right-6 h-8 md:h-10 opacity-90">
                        
                        <img src="https://placehold.co/30x20/ffc42a/0076a3?text=Chip" alt="Chip" class="h-6 mb-8 mt-2">
                        
                        <!-- 2. VISA Logo (New location: Centered and Subtler) -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="card-visa-center">VISA</span>
                        </div>
                        
                        <!-- Card Number Display (Sensitive field) -->
                        <p id="card-number-display" class="text-2xl sm:text-3xl tracking-widest font-mono mb-6 text-white/90">
                            **** **** **** 1234
                        </p>
                        
                        <div class="flex justify-between items-center text-xs opacity-80">
                            <div>
                                <p class="uppercase font-light">Card Holder</p>
                                <p id="card-holder-name" class="uppercase font-medium text-sm">LOADING NAME</p>
                            </div>
                            <!-- Expiry and CVV Container -->
                            <div class="flex space-x-6">
                                <div class="text-right">
                                    <p class="uppercase font-light">Expires</p>
                                    <p id="card-expiry" class="font-medium text-sm">--/--</p>
                                </div>
                                <div class="text-right">
                                    <p class="uppercase font-light">CVV</p>
                                    <p id="card-cvv-display" class="font-medium text-sm">***</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Card Detail Controls -->
                <div class="flex justify-center -mt-4 mb-6">
                    <button id="show-details-button" onclick="toggleCardDetails()" class="flex items-center space-x-2 text-sm font-semibold text-bank-blue hover:text-bank-yellow transition duration-150 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" id="eye-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <span id="details-text">Show Card Details</span>
                    </button>
                </div>

                <!-- CARD CONTROLS SECTION -->
                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg border border-gray-50 mt-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Card Controls</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        
                        <button id="freeze-button" onclick="toggleCardFreeze()" class="flex flex-col items-center justify-center p-4 rounded-lg shadow-md transition duration-200 
                                text-white font-semibold bg-bank-blue hover:bg-bank-blue/90 active:scale-[.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0v4m-5 9h2l-.5 4h-1l-.5-4zm-7-9h14a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V11a2 2 0 012-2z" /></svg>
                            <span id="freeze-text">Freeze Card</span>
                        </button>

                        <button onclick="handleCardAction('Change PIN')" class="flex flex-col items-center justify-center p-4 rounded-lg shadow-md transition duration-200 
                                text-gray-800 font-semibold bg-gray-100 hover:bg-bank-yellow/50 active:scale-[.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-bank-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2v5.5a4.5 4.5 0 01-9 0V9a2 2 0 012-2m5 0a2 2 0 012-2h-5c-1.1 0-2 .9-2 2v10a2 2 0 002 2h3a2 2 0 002-2v-3" /></svg>
                            Change PIN
                        </button>
                        
                        <button onclick="handleCardAction('Report Lost/Stolen')" class="flex flex-col items-center justify-center p-4 rounded-lg shadow-md transition duration-200 
                                text-white font-semibold bg-red-600 hover:bg-red-700 active:scale-[.98]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.368 15c-.77 1.333.192 3 1.732 3z" /></svg>
                            Report Lost
                        </button>
                    </div>
                </div>

            </div>
            
        </main>

    </div>

    <footer class="w-full p-4 bg-white shadow-inner mt-auto">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between text-xs text-gray-500 space-y-4 md:space-y-0">
            
            <div class="flex items-center space-x-2">
                <div class="flex items-center bg-bank-blue text-white p-1 rounded">
                    <p class="font-bold">Sunflower Bank First National</p><span class="text-xs ml-1">.gfx</span>
                </div>
            </div>
            
            <div class="text-center">
                <p>Routing Number: 101130607</p>
                <p>Consumer Service: 888.833.5961</p>
                <p>&copy; 2019 First National 1978, a division of Sunflower Bank, N.A. All Rights Reserved.</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/40x20/0076a3/ffffff?text=EQUAL+HOUSING" alt="Equal Housing Lender" class="h-5">
                <img src="https://placehold.co/40x20/0076a3/ffffff?text=FDIC" alt="FDIC" class="h-5">
            </div>
        </div>
    </footer>

   <script>
    const API_BASE_URL = 'http://localhost:46361:3000/api'; 
    const SESSION_KEY_TOKEN = 'userToken'; // Standardized Key
    const LOGIN_PAGE_URL = '../index.html'; // Standardized Fallback URL
    const FORCE_USER_ID_DEBUG = false;
    const DEBUG_USER_ID = '68dfd68196b17f83f44f42b4'; // Example User ID
    
    // =========================================================================
    
    // Global State
    let isCardFrozen = false;
    let isCardDetailsRevealed = false;
    
    // Removed mock sensitive data from cardData
    let cardData = {
        cardHolderName: 'LOADING NAME',
        displayCardNumber: '**** **** **** 1234',
        expiryDate: '--/--',
        isFrozen: false,
    };
    
    // NEW STATE: Stores sensitive data only after a successful, secure fetch
    let sensitiveCardData = {
        fullCardNumber: null, 
        cvv: null
    };

    // --- Sidebar Logic (unchanged) ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        sidebar.classList.toggle('open');
        backdrop.classList.toggle('open');
        const menuButton = document.getElementById('menu-button');
        const isOpen = sidebar.classList.contains('open');
        menuButton.setAttribute('aria-expanded', isOpen);
    }

    // Custom message box function to replace alert() (unchanged)
    function showMessage(message, title = 'Notification') {
        const container = document.getElementById('message-box-container');
        container.innerHTML = `
            <div class="message-box">
                <h3 class="text-xl font-bold mb-2 text-bank-blue">${title}</h3>
                <p class="text-gray-700">${message}</p>
                <button onclick="closeMessage()">Close</button>
            </div>
            <div class="fixed inset-0 bg-black/50" onclick="closeMessage()"></div>
        `;
        container.classList.remove('hidden');
    }

    function closeMessage() {
        document.getElementById('message-box-container').classList.add('hidden');
    }
    
    // --- LOGOUT FUNCTION (unchanged) ---
    function handleLogout() {
        sessionStorage.removeItem('userToken');
        sessionStorage.removeItem('currentUserId');
        showMessage('You have been logged out.', 'Success');
        setTimeout(() => {
            // In a real application, this would redirect to the login page
            // window.location.href = '../index.html'; 
            console.log("Redirecting to login page...");
        }, 500);
    }

    // --- CARD MANAGEMENT LOGIC ---
    
    /**
     * Fetches non-sensitive card data from the back-end API and populates the UI.
     */
    async function fetchCardData() {
        // ... (API call and initial UI setup logic remains the same) ...
        let token = sessionStorage.getItem('userToken');

        if (FORCE_USER_ID_DEBUG) {
            console.warn('DEBUG MODE: Attempting to fetch a temporary token for known good user ID.');
            try {
                const debugResponse = await fetch(API_BASE_URL + '/admin/debug/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: DEBUG_USER_ID })
                });

                if (debugResponse.ok) {
                    const debugResult = await debugResponse.json();
                    token = debugResult.token; 
                    console.log('Successfully obtained debug token.');
                } else {
                    console.error('Failed to get debug token. Using session token.');
                }
            } catch (e) {
                console.error('Debug token request failed:', e);
            }
        }
        
        if (!token) {
            document.getElementById('card-holder-name').textContent = 'UNAUTHORIZED';
            showMessage('Session expired or no token found. Redirecting to login.', 'Authentication Required');
            setTimeout(handleLogout, 1500);
            return;
        }

        try {
            const response = await fetch(API_BASE_URL + '/client/card', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                throw new Error(result.message || 'Failed to fetch card data.');
            }

            const data = result.data;

            // Handle case where user has no card generated yet
            if (data.hasCard === false) {
                 document.getElementById('card-holder-name').textContent = data.fullName || 'NO CARD';
                 return;
            }
            
            // Update Global State (non-sensitive)
            cardData.cardHolderName = data.cardHolderName;
            cardData.displayCardNumber = data.displayCardNumber;
            cardData.expiryDate = data.expiryDate;
            
            // Synchronize initial isFrozen state with the server's response.
            isCardFrozen = data.isFrozen; 
            
            // Update UI elements
            document.getElementById('card-holder-name').textContent = cardData.cardHolderName;
            document.getElementById('card-number-display').textContent = cardData.displayCardNumber;
            document.getElementById('card-expiry').textContent = cardData.expiryDate;
            document.getElementById('card-cvv-display').textContent = '***'; // Masked by default
            
            // Update Avatar (using initials from fullName)
            const initials = (data.fullName || 'US').split(' ').map(n => n[0]).join('');
            document.getElementById('avatar-img').src = `https://placehold.co/40x40/ffc42a/0076a3?text=${initials}`;

            // Call the UI update function to apply the fetched state immediately.
            updateCardFreezeUI();

        } catch (error) {
            console.error('Card Load Error:', error);
            document.getElementById('card-holder-name').textContent = 'ERROR';
            showMessage(error.message || 'Could not load card data. Please check your connection and try again.', 'Connection Error');
        }
    }

    /**
     * Toggles the card's freeze status by calling the backend API. (unchanged)
     */
    async function toggleCardFreeze() {
        // ... (unchanged logic) ...
        const token = sessionStorage.getItem('userToken');
        if (!token) return handleLogout();

        // Hide details if they were showing before freezing
        if (isCardDetailsRevealed) {
            toggleCardDetails(); 
        }
        
        const shouldFreeze = !isCardFrozen; // The intended new state
        const actionText = shouldFreeze ? 'Freezing' : 'Unfreezing';
        
        const freezeButton = document.getElementById('freeze-button');
        const originalText = freezeButton.querySelector('#freeze-text').textContent;
        
        // Start loading state visually
        freezeButton.disabled = true;
        freezeButton.querySelector('#freeze-text').textContent = `${actionText}...`;
        
        try {
            const response = await fetch(API_BASE_URL + '/client/card/freeze', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ shouldFreeze })
            });

            const result = await response.json();
            
            if (!response.ok || !result.success) {
                throw new Error(result.message || `Failed to ${actionText.toLowerCase()} card.`);
            }
            
            // Update state from API response
            isCardFrozen = result.data.isFrozen;
            updateCardFreezeUI();
            
            const status = isCardFrozen ? 'FROZEN' : 'ACTIVE';
            const message = `Your Sunflower Card is now **${status}**.`;
            showMessage(message, 'Card Status Updated');

        } catch (error) {
            console.error('Card Toggle Error:', error);
            showMessage(error.message || 'An error occurred while updating card status.', 'Update Failed');
            
            // Revert button text on failure
            freezeButton.querySelector('#freeze-text').textContent = originalText; 

        } finally {
            freezeButton.disabled = false;
        }
    }

    /**
     * Updates the visual state of the card and button based on isCardFrozen state. (unchanged)
     */
    function updateCardFreezeUI() {
        // ... (unchanged logic) ...
        const cardDisplay = document.getElementById('card-display');
        const freezeButton = document.getElementById('freeze-button');
        const freezeText = document.getElementById('freeze-text');
        const statusOverlay = document.getElementById('card-status-overlay');

        if (isCardFrozen) {
            cardDisplay.classList.add('frozen');
            statusOverlay.classList.remove('opacity-0');
            
            // Update button for unfreeze action
            freezeButton.classList.remove('bg-bank-blue', 'hover:bg-bank-blue/90');
            freezeButton.classList.add('bg-green-600', 'hover:bg-green-700');
            freezeText.textContent = 'Unfreeze Card';
        } else {
            cardDisplay.classList.remove('frozen');
            statusOverlay.classList.add('opacity-0');

            // Update button for freeze action
            freezeButton.classList.add('bg-bank-blue', 'hover:bg-bank-blue/90');
            freezeButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            freezeText.textContent = 'Freeze Card';
        }
    }
    
    /**
     * Toggles the display of the full card number and CVV.
     */
    async function toggleCardDetails() { // Made asynchronous to await the fetch
        const numberDisplay = document.getElementById('card-number-display');
        const cvvDisplay = document.getElementById('card-cvv-display');
        const detailsButton = document.getElementById('show-details-button'); 
        const detailsText = document.getElementById('details-text');
        const eyeIcon = document.getElementById('eye-icon');
        const token = sessionStorage.getItem('userToken');

        if (isCardDetailsRevealed) {
            // CASE 1: Hiding details (always successful locally)
            isCardDetailsRevealed = false;
            numberDisplay.textContent = cardData.displayCardNumber;
            cvvDisplay.textContent = '***';
            detailsText.textContent = 'Show Card Details';
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
            detailsButton.disabled = false;
            return;
        }
        
        // CASE 2: Revealing details (Requires secure fetch)
        
        // If data is already fetched, just display it
        if (sensitiveCardData.fullCardNumber && sensitiveCardData.cvv) {
            isCardDetailsRevealed = true;
            numberDisplay.textContent = sensitiveCardData.fullCardNumber; 
            cvvDisplay.textContent = sensitiveCardData.cvv;
            detailsText.textContent = 'Hide Card Details';
        } else {
            // Data not fetched yet: Perform the secure API call
            detailsButton.disabled = true;
            detailsText.textContent = 'Loading...';
            
            try {
                // ðŸ›‘ NEW SECURE API CALL to fetch sensitive data
                const response = await fetch(API_BASE_URL + '/client/card/sensitive', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // ðŸ›‘ FIX: Safely read and handle non-OK responses (like the 404 HTML page)
                if (!response.ok) {
                    
                    let errorMessage = `API Error (${response.status} ${response.statusText}): Could not fetch sensitive card details.`;
                    
                    if (response.status === 404) {
                        // Specific message for the missing route
                        errorMessage = `Backend Error: Route /client/card/sensitive not found (404).`;
                    }
                    
                    // Try reading as JSON for a better message, but fall back to the status message
                    try {
                        const errorJson = await response.json();
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        // Ignore SyntaxError on HTML/non-JSON response body
                        console.warn('Received non-JSON error body, falling back to status message.');
                    }
                    
                    throw new Error(errorMessage);
                }

                // If response.ok is true, safely parse the JSON
                const result = await response.json(); 
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to fetch sensitive card details.');
                }
                
                // Store the real data in the global state
                sensitiveCardData.fullCardNumber = result.data.fullCardNumber.match(/.{1,4}/g).join(' '); // Format with spaces
                sensitiveCardData.cvv = result.data.cvv;

                // Update UI using the real data
                isCardDetailsRevealed = true;
                numberDisplay.textContent = sensitiveCardData.fullCardNumber; 
                cvvDisplay.textContent = sensitiveCardData.cvv;
                detailsText.textContent = 'Hide Card Details';

                // Temporary message for security reminder
                showMessage('The full card number and CVV are now visible. For your security, they will automatically hide when you navigate away or after a short delay.', 'Security Alert');

            } catch (error) {
                console.error('Sensitive Details Fetch Error:', error);
                showMessage(error.message || 'Could not securely load full card details.', 'Security Error');
                
                // Reset button on failure
                detailsText.textContent = 'Show Card Details';
                detailsButton.disabled = false;
                return;
            }
        }
        
        // Final UI updates for show state (Success or pre-fetched)
        // Change eye icon to slash (eye-slash)
        eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 1.141 0 2.228.196 3.235.568M21 12c-1.274 4.057-5.064 7-9.542 7a9.99 9.99 0 01-2.458-.367m1.23-2.651l.885.34m-3.137-.48l1.378-1.554M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />';
        detailsButton.disabled = false;

    }

    /**
     * Handles other critical card actions like PIN change or reporting. (unchanged)
     * @param {string} actionName - The name of the action (e.g., 'Change PIN')
     */
    function handleCardAction(actionName) {
        // Hide details if they were showing before a major action
        if (isCardDetailsRevealed) {
            toggleCardDetails(); 
        }

        if (actionName === 'Report Lost/Stolen') {
            showMessage('If you proceed, your card will be permanently canceled and a new one ordered. Please call our 24/7 hotline at 888.833.5961 immediately.', actionName + ' Confirmation');
        } else {
            showMessage(`You will be redirected to a secure page to complete the **${actionName}** process.`, actionName);
        }
    }


    // --- Event Listeners (unchanged) ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchCardData();
        // Attach global functions to window so they can be called from HTML attributes
        window.toggleSidebar = toggleSidebar;
        window.handleLogout = handleLogout;
        window.toggleCardFreeze = toggleCardFreeze;
        window.toggleCardDetails = toggleCardDetails;
        window.handleCardAction = handleCardAction;
        window.closeMessage = closeMessage;
    });
</script>
</body>
</html>
